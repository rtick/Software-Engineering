<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <script src="./rollups/aes.js"></script>
    <script src="./rollups/sha1.js"></script>
    <script src="./components/core-min.js"></script>
    <script src="./components/enc-base64-min.js"></script>
    <script src="./components/enc-utf16.js"></script>
</head>
<body>
    <a id = "download" class="button download green" style = "display:none">Download</a>
<nav role="navigation" class="navbar navbar-default">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" data-target="#navbarCollapse" data-toggle="collapse" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="login.html" class="navbar-brand">FileUpload</a>
        </div>
        <!-- Collection of nav links and other content for toggling -->
        <div id="navbarCollapse" class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="#">Profile</a></li>
                <li><a href="#">Settings</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="login.html">Logout</a></li>
            </ul>
        </div>
    </nav>
<div class="page-header" align = "center">
  <h1 style = "font-size:24px" id = "welcome"></h1>
    <button id = "upload" class="btn btn-default fButton">Upload File</button>
    <br>
    <br>
    <form method="post" enctype="multipart/form-data" id = "form">
        <input type="file" class = "fButton" name="file" size="50" id = "hidden" style="display:none;margin:auto;width:60%;padding:10px"/>
        <input type="submit" class = "btn btn-default fButton" id = "confirm2" style="display:none;margin:auto;padding:10px"/>
    </form>
    <button id = "confirm" class="btn btn-default fButton" style = "display:none;margin:auto;width:60%;padding:10px"></button>
</div>
<br>
<br>
<div class = "container-fluid" align = "center">
    <div class = "row">
        <div class="col-sm-8">
            <table class="table" id = "table">
    <thead>
      <tr>
        <th>File Name</th>
        <th>File Size</th>
        <th>Shared With</th>
          <th></th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
        </div>
        <div class="col-sm-4"></div>
    </div>
</div>
</body>
<style>
    body {
        background-image: url("clouds.jpg");
    }
    .fButton:hover
    {
        background-color:#0033cc;
        border-color:black;
        color:white;
    }
    .page-header{
        margin-top: 25px !important;
        padding: 5px;
        width: auto;
        min-width: 320px;
        max-width: 400px;
        height: 200px;
        background-color: #00ffff;
        margin:0 auto;
        border-radius: 10px;
        border: 1px solid black;
        text-align: center;
    }
    a {
        color: black;
    }
    table, th, td {
        border: 1px solid black;
    }
    th,td {
        background-color: #00ffff;
        color: black;
    }
    .table>thead>tr>th
    {
        border: 1px solid black;
    }
    table {
        border-collapse: collapse;
    }
    .navbar-default {
        background-color: #00ffff;
        border-color: #0033cc;
    }
    .navbar-default .navbar-brand {
        color: #000000;
    }
    .navbar-default .navbar-brand:hover, .navbar-default .navbar-brand:focus {
        color: #fbfbfb;
        background-color:#0033cc;
    }
    .navbar-default .navbar-text {
        color: #000000;
    }
    .navbar-default .navbar-nav > li > a {
        color: #000000;
    }
    .navbar-default .navbar-nav > li > a:hover, .navbar-default .navbar-nav > li > a:focus {
        color: #fbfbfb;
        background-color:#0033cc;
    }
    .navbar-default .navbar-nav > .active > a, .navbar-default .navbar-nav > .active > a:hover, .navbar-default .navbar-nav > .active > a:focus {
        color: #fbfbfb;
        background-color: #0033cc;
    }
    .navbar-default .navbar-nav > .open > a, .navbar-default .navbar-nav > .open > a:hover, .navbar-default .navbar-nav > .open > a:focus {
        color: #fbfbfb;
        background-color: #0033cc;
    }
    .navbar-default .navbar-toggle {
        border-color: #0033cc;
    }
    .navbar-default .navbar-toggle:hover, .navbar-default .navbar-toggle:focus {
        background-color: #0033cc;
    }
    .navbar-default .navbar-toggle .icon-bar {
        background-color: #000000;
    }
    .navbar-default .navbar-collapse,
    .navbar-default .navbar-form {
        border-color: #000000;
    }
    .navbar-default .navbar-link {
        color: #000000;
    }
    .navbar-default .navbar-link:hover {
        color: #fbfbfb;
    }

    @media (max-width: 767px) {
        .navbar-default .navbar-nav .open .dropdown-menu > li > a {
            color: #000000;
        }
        .navbar-default .navbar-nav .open .dropdown-menu > li > a:hover, .navbar-default .navbar-nav .open .dropdown-menu > li > a:focus {
            color: #fbfbfb;
        }
        .navbar-default .navbar-nav .open .dropdown-menu > .active > a, .navbar-default .navbar-nav .open .dropdown-menu > .active > a:hover, .navbar-default .navbar-nav .open .dropdown-menu > .active > a:focus {
            color: #fbfbfb;
            background-color: #0033cc;
        }
    }
</style>
<script>
    $(document).ready(function() {
        var username = getCookie("fileServiceUsername");
        var ip = document.location.host;
        ip = ip.split(":")[0];
        console.log(username);
        document.cookie = "fileServiceUsername=;expires=Thu, 01 Jan 1970 00:00:01 GMT;";
        $("#form").attr("action", "http://" + ip + ":4000/fileService/uploadFile/" + username + "/" + ip);
        $.get("http://" + ip + ":4000/fileService/getName/" + username, function (data) {
            $("#welcome").html("Welcome " + data);
            $.get("http://" + ip + ":4000/fileService/getList/" + username, function (data) {
                console.log(data);
                console.log(data.length);
                for (var i = data.length - 1; i >= 0; i--) {
                    $('#table').append('<tr><td><li style="list-style-type: none"><a role="button" class = "lTable">' + data[i][0] + '</a></li></td><td>' + data[i][1] + ' KB</td><td></td><td><li style="list-style-type: none"><a role="button" class = "delete" id = "' + data[i][0] + '"><i class="fa fa-trash-o"></a></td></tr>');
                }
            });
        });
        $(document).on('click', "a.lTable", function () {
            var name = $(this).html();
            if (name.split('.').pop() == "txt") {
                $.get("http://" + ip + ":4000/fileService/getFile/" + username + "/" + name, function (data) {
                    var decrypted = CryptoJS.AES.decrypt(data, "AEIOU123").toString(CryptoJS.enc.Latin1);
                    console.log(decrypted)
                    $("#download").attr('href', 'data:application/octet-stream,' + decrypted);
                    $("#download").attr('download', name);
                    document.getElementById('download').click();
                });
            }
            else
            {
                window.open("http://" + ip + ":4000/fileService/getFile/" + username + "/" + $(this).html(), function (data) {
                });
            }
        });
        $(document).on('click', "a.delete", function () {
            var r = confirm("Are you sure you want to delete " + $(this).attr("id") + "?");
            if (r == true) {
                $.get("http://" + ip + ":4000/fileService/deleteFile/" + username + "/" + $(this).attr("id"), function (data) {
                    document.cookie = "fileServiceUsername=" + username + ";path=/";
                    window.open("main.html", "_self");
                });
            }
        });
        function getCookie(name) {
            var value = "; " + document.cookie;
            var parts = value.split("; " + name + "=");
            if (parts.length == 2) return parts.pop().split(";").shift();
        }

        $('#upload').click(function () {
            $(this).css('background-color', '#0033cc');
            $(this).css('border-color', 'black');
            $(this).css('color', 'white');
            $('#hidden').click();
        });
        $("#hidden").change(function () {
            //submit the form here
            $('#confirm').css('display', 'block');
            var filename = $('#hidden').val().split('\\').pop();
            $('#confirm').html("Upload " + filename);
            $('#form').css('display', 'block');
        });

        $("#confirm").click(function () {
            if ($('#hidden').val().split('\\').pop().split('.').pop() == "txt") {
                var fr = new FileReader();
                fr.onload = function (e) {
                    var rawData = fr.result;
                    var encrypted = CryptoJS.AES.encrypt(fr.result, "AEIOU123");
                    console.log(encrypted);
                    var fd = new FormData();
                    console.log(fd);
                    console.log("tesasasst");
                    fd.append('file', encrypted);
                    $.ajax({
                        url: "http://" + ip + ":4000/fileService/uploadText/" + username + "/" + ip + "/" + $('#hidden').val().split('\\').pop(),
                        data: fd,
                        processData: false,
                        contentType: false,
                        type: 'POST',
                        success: function (data) {
                            eval(data);
                        }
                    });
                }
                fr.readAsBinaryString($("#hidden")[0].files[0]);
            }
            else
            {
                console.log($("#hidden")[0].files[0]);
                $("#confirm2").click();
            }
        })
    });
</script>
</html>